---
- name: Build kolla-ansible image
  hosts: all

  tasks:
    - name: Log into registry
      community.docker.docker_login:
        registry_url: "{{ docker_registry }}"
        username: "{{ secret.DOCKER_USERNAME }}"
        password: "{{ secret.DOCKER_PASSWORD }}"
      when: push_image | bool
      no_log: true

    - name: Run build script
      ansible.builtin.shell:
        executable: /bin/bash
        chdir: "{{ zuul.project.src_dir }}"
        cmd: |
          set -e
          set -o pipefail
          set -x

          CREATED=$(date --rfc-3339=ns)
          REVISION=$(git rev-parse --short HEAD)

          # NOTE: For builds for a specific release, the OpenStack version is taken
          #       from the release repository.
          if [[ $VERSION != "latest" ]]; then
              filename=$(curl -L https://raw.githubusercontent.com/osism/release/main/$VERSION/openstack.yml)
              OPENSTACK_VERSION=$(curl -L https://raw.githubusercontent.com/osism/release/main/$VERSION/$filename | grep "openstack_version:" | awk -F': ' '{ print $2 }')
          fi

          . defaults/$OPENSTACK_VERSION.sh

          if [[ -n $REGISTRY ]]; then
              REPOSITORY="$REGISTRY/$REPOSITORY"
          fi

          docker buildx create --use --driver=docker-container
          docker buildx build \
              --build-arg "IS_RELEASE=$IS_RELEASE" \
              --build-arg "OPENSTACK_VERSION=$OPENSTACK_VERSION" \
              --build-arg "VERSION=$VERSION" \
              --label "org.opencontainers.image.created=$CREATED" \
              --label "org.opencontainers.image.documentation=https://docs.osism.tech" \
              --label "org.opencontainers.image.licenses=ASL 2.0" \
              --label "org.opencontainers.image.revision=$REVISION" \
              --label "org.opencontainers.image.source=https://github.com/osism/container-image-kolla-ansible" \
              --label "org.opencontainers.image.title=kolla-ansible" \
              --label "org.opencontainers.image.url=https://www.osism.tech" \
              --label "org.opencontainers.image.vendor=OSISM GmbH" \
              --label "org.opencontainers.image.version=$VERSION" \
              --label "de.osism.release.openstack=$OPENSTACK_VERSION" \
              --load \
              --tag "$(git rev-parse --short HEAD)" \
              $BUILD_OPTS \
              .  # <-- there is a dot
      changed_when: false
      environment:
        IS_RELEASE: false
        OPENSTACK_VERSION: "{{ version_openstack }}"
        PUSH_IMAGE: "{{ push_image | bool }}"
        REGISTRY: "{{ docker_registry }}"
        REPOSITORY: "{{ docker_namespace }}/kolla-ansible"
        VERSION: latest

    - name: Run push script
      ansible.builtin.shell:
        executable: /bin/bash
        chdir: "{{ zuul.project.src_dir }}"
        cmd: |
          set -e
          set -o pipefail
          set -x

          COMMIT=$(git rev-parse --short HEAD)

          # NOTE: For builds for a specific release, the OpenStack version is taken from the release repository.
          if [[ $VERSION != "latest" ]]; then
              filename=$(curl -L https://raw.githubusercontent.com/osism/release/main/$VERSION/openstack.yml)
              OPENSTACK_VERSION=$(curl -L https://raw.githubusercontent.com/osism/release/main/$VERSION/$filename | grep "openstack_version:" | awk -F': ' '{ print $2 }')
          fi

          . defaults/$OPENSTACK_VERSION.sh

          if [[ -n $REGISTRY ]]; then
              REPOSITORY="$REGISTRY/$REPOSITORY"
          fi

          if [[ $OPENSTACK_VERSION == "master" ]]; then
              tag=$REPOSITORY:latest

              docker tag "$COMMIT" "$tag"
              docker push "$tag"
          else
              if [[ $VERSION == "latest" ]]; then
                  tag=$REPOSITORY:$OPENSTACK_VERSION
              else
                  tag=$REPOSITORY:$VERSION
              fi

              docker tag "$COMMIT" "$tag"
              docker push "$tag"
          fi
      when: push_image | bool
      changed_when: false
      environment:
        OPENSTACK_VERSION: "{{ version_openstack }}"
        REGISTRY: "{{ docker_registry }}"
        REPOSITORY: "{{ docker_namespace }}/kolla-ansible"
        VERSION: latest
